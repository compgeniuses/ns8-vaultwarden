#!/usr/bin/env python3

#
# Copyright (C) 2023 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later

import os
import json
import sys
import agent
import secrets
import pyargon2
import binascii
import subprocess

try:
    import pyargon2
except ModuleNotFoundError:
    print("pyargon2 not found. Attempting to install...")

    # Try pip install
    try:
        subprocess.run(["pip", "install", "pyargon2"], check=True)
    except subprocess.CalledProcessError:
        # If pip install fails, try pip3 install
        try:
            subprocess.run(["pip3", "install", "pyargon2"], check=True)
        except subprocess.CalledProcessError:
            print("Failed to install pyargon2. Please install it manually.")
            sys.exit(1)

    # Try importing pyargon2 again
    try:
        import pyargon2
    except ModuleNotFoundError:
        print("pyargon2 installation successful but import still failed.")
        sys.exit(1)

# Now pyargon2 is successfully imported, continue with your script

data = json.load(sys.stdin)

# Generate a random hex string of length 40
def generate_random_hex(length):
    random_bytes = secrets.token_bytes(length)
    random_hex = binascii.hexlify(random_bytes).decode('utf-8')
    return random_hex

# Generate a random admin token
VAULTWARDEN_ADMIN_TOKEN = generate_random_hex(20)

# Hash the admin token using Argon2
hashed_admin_token = pyargon2.hash.hash_password(VAULTWARDEN_ADMIN_TOKEN)

# Set the environment variable
agent.set_env("ADMIN_TOKEN", hashed_admin_token)

# Make sure everything is saved inside the environment file
# just before starting systemd unit
agent.dump_env()
